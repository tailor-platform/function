# @tailor-platform/function-typeorm-tailordb

TypeORM integration helpers for TailorDB.

This package provides minimal components to execute SQL and manage transactions against TailorDB with a Postgres-like shape, intended to be used alongside TypeORM. It exposes a lightweight query runner and utilities that mirror common TypeORM patterns.

Important: Schema sync and migrations are not supported. TailorDB is the source of truth for schema, and code should be generated from the live schema using the companion codegen package.

Note: TypeORM does not currently support plugging in an external driver via public APIs the same way Kysely does. This package focuses on a pragmatic subset: executing queries and transactions using a TailorDB client and Postgres-compatible SQL generated by TypeORM. Advanced features (schema sync, migrations via driver hooks, replication, etc.) are out of scope for the initial version.

## Install

```sh
npm install @tailor-platform/function-typeorm-tailordb
```

We recommend installing `@tailor-platform/function-types` for TailorDB typings when working in the Function service.

### Using @tailor-platform/function-types

`@tailor-platform/function-types` provides ambient type declarations for Tailor Platform globals such as `tailordb`, `tailor.secretmanager`, etc.

1) Install as a dev dependency

```sh
npm install -D @tailor-platform/function-types
```

2) Add to your `tsconfig.json` so TypeScript picks up the globals

```json
{
  "compilerOptions": {
    "types": ["@tailor-platform/function-types"]
  }
}
```

After this, you can use the global `tailordb.Client` with proper types without importing it:

```ts
const client = new tailordb.Client({ namespace: "<namespace>" });
await client.connect();
const result = await client.queryObject<{ now: string }>("select now() as now");
```

## Usage

```ts
import { TailordbClientQueryRunner } from '@tailor-platform/function-typeorm-tailordb';

const client = new tailordb.Client({ namespace: '<tailordb namespace>' });
await client.connect();

const qr = new TailordbClientQueryRunner(client);

// Execute raw SQL
await qr.query('select 1');

// Transaction helpers
await qr.startTransaction();
try {
  await qr.query('insert into foo(bar) values($1)', ['baz']);
  await qr.commitTransaction();
} catch (e) {
  await qr.rollbackTransaction();
  throw e;
}

await client.end();
```

This query runner is intentionally minimal and designed for raw queries or integration scenarios where you manually tie it into your data access layer.

## Experimental: TypeORM DataSource integration

TypeORM はカスタムドライバの公開 API がなく、公式サポート外です。本パッケージでは実験的に DriverFactory をパッチして `type: 'tailordb'` の DataSource を作れる試作ドライバを提供します。QueryBuilder/Repository の全機能は保証しません（`DataSource.query()` や単純な SQL 実行、トランザクションは動作します）。

1) 事前に types を導入（任意）

```sh
npm install -D @tailor-platform/function-types
```

2) ドライバ登録と DataSource 初期化（2通り）

```ts
// A) ファクトリ関数（推奨）：非公開 API のパッチを内部に隠蔽
import { initTailordbDataSource } from '@tailor-platform/function-typeorm-tailordb';

const dataSource = await initTailordbDataSource({
  tailordb: { namespace: '<tailordb namespace>' },
  // entities など TypeORM オプションをそのまま渡せます
  entities: [],
  logging: false,
});

// B) 直接パッチして使う（詳細把握している場合のみ）
// import { DataSource } from 'typeorm';
// import { registerTailordbDriver } from '@tailor-platform/function-typeorm-tailordb';
// await registerTailordbDriver();
// const dataSource = new DataSource({
//   type: 'tailordb' as any,
//   tailordb: { namespace: '<tailordb namespace>' },
//   synchronize: false,
//   logging: false,
// });
// await dataSource.initialize();

// 最小限のクエリ実行
const rows = await dataSource.query('select 1 as one');

// 取引
const qr = dataSource.createQueryRunner();
await qr.startTransaction();
try {
  await qr.query('insert into app.sample(col) values($1)', ['val']);
  await qr.commitTransaction();
} catch (e) {
  await qr.rollbackTransaction();
  throw e;
} finally {
  await qr.release();
}

await dataSource.destroy();
```

制約事項（プロトタイプ）
- `Repository`/`QueryBuilder` は多くのケースで未対応または制限があります。
- スキーマ同期（`synchronize`/`migrations`）は非対応です。
- パラメータ埋め込みは `$1` スタイルまたは `:name` を `$n` に変換する程度の最小実装です。

### Repository / QueryBuilder の基本 CRUD 例（限定サポート）

エンティティを DataSource に登録すれば、シンプルな CRUD が動く範囲で利用できます（複雑なクエリやリレーションの高度な機能は未保証）。

```ts
import { DataSource } from 'typeorm';
import { registerTailordbDriver } from '@tailor-platform/function-typeorm-tailordb';
import { App_Users } from './entities'; // codegen 出力例

await registerTailordbDriver();

const ds = new DataSource({
  type: 'tailordb' as any,
  tailordb: { namespace: '<namespace>' },
  entities: [App_Users],
  synchronize: false,
});
await ds.initialize();

const repo = ds.getRepository(App_Users);

// Create
const created = await repo.save({ name: 'Alice', email: 'alice@example.com' });

// Read
const found = await repo.findOne({ where: { id: created.id } });

// Update
await repo.update({ id: created.id }, { name: 'Alice Updated' });

// Delete
await repo.delete({ id: created.id });

await ds.destroy();
```

注意事項
- 複雑な `QueryBuilder`/`Repository` の機能（結合、リレーションの cascade、部分更新の戻り値の扱いなど）は未対応の可能性があります。
- `RETURNING` を伴う INSERT/UPDATE は基本サポートしますが、ドライバ内部仕様変更により破綻する可能性があります。
